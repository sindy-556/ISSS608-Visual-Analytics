{
  "hash": "0c7b0afaf0ae0bb0e96e609cb69b66c8",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Take-home Exercise 3:GeBiz Procurement Data Visualization Prototype\"\nauthor: \"Sindy\"\ndate-modified: \"last-modified\"\noutput:\n  html_document:\n    css: styles.css\nexecute:\n  echo: true\n  eval: true\n  warning: false\n  freeze: true\n---\n\n\n\n\n## Overview\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(dplyr, stringr, lubridate, networkD3, tidyverse, \n               plotly, DT, viridis, scales, htmlwidgets, htmltools)\n```\n:::\n\n\n\n\n\n\n## Include info from external datasets\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinancial_df <- read.csv('data/supplier_details.csv')  # CSV with supplier financial grades\nprocurement_df <- read.csv('data/GovernmentProcurementviaGeBIZ.csv')  # Procurement data CSV\nagency_mapping_df <- read.csv('data/agency_mapping.csv')  # Agency mapping data\n\n# 1. Extract just the S-grade (S2-S10) from the financial grade string\nextract_s_grade <- function(grade_string) {\n  if (is.na(grade_string)) {\n    return(NA)\n  }\n  \n  # Use regex to extract S followed by a number\n  match <- str_extract(grade_string, \"S\\\\d+\")\n  return(match)\n}\n\n# Create simplified financial grades\nfinancial_df$financial_grade <- sapply(financial_df$financial_grade, extract_s_grade)\n\n# 2. Create mapping dataframes for lookups\nsupplier_grade_map <- financial_df %>% \n  select(supplier_name, financial_grade) %>%\n  distinct()\n\n# 3. Apply the financial grade mapping to the procurement dataset\nprocurement_enriched <- procurement_df %>%\n  left_join(supplier_grade_map, by = \"supplier_name\")\n\n# 4. Create agency information mappings\nagency_mapping <- agency_mapping_df %>%\n  select(agency, agency_abbr, ministry, ministry_abbr)\n\n# 5. Add agency information to the procurement dataframe\nprocurement_enriched <- procurement_enriched %>%\n  left_join(agency_mapping, by = \"agency\")\n\nwrite.csv(procurement_enriched, 'procurement_output.csv', row.names = FALSE)\n\n# Display some statistics to verify the results\ncat(\"Total procurement records:\", nrow(procurement_enriched), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal procurement records: 18638 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Records with financial grades:\", sum(!is.na(procurement_enriched$simple_grade)), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRecords with financial grades: 0 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Records with agency abbreviations:\", sum(!is.na(procurement_enriched$agency_abbr)), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRecords with agency abbreviations: 18638 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Records with ministry information:\", sum(!is.na(procurement_enriched$ministry)), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRecords with ministry information: 18638 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Show a sample of the enriched data\nhead(procurement_enriched)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          tender_no\n1 ACR000ETT18300010\n2 ACR000ETT18300011\n3 ACR000ETT19300001\n4 ACR000ETT19300002\n5 ACR000ETT19300003\n6 ACR000ETT19300004\n                                                                                                                                                                                          tender_description\n1 SUPPLY, DESIGN, DEVELOPMENT, CUSTOMIZATION, DELIVERY, INSTALLATION, TESTING, COMMISSIONING AND MAINTENANCE OF A VARIABLE CAPITAL COMPANIES (VCC) SYSTEM FOR ACCOUNTING AND CORPORATE REGULARTORY AUTHORITY\n2                APPLICATION ENHANCEMENT, CUSTOMISATION, MIGRATION, DELIVERY, INSTALLATION, TESTING AND COMMISSIONING OF THE FULLY OPERATIONAL BIZFINx 2.0 APPLICATION SYSTEM WITH AN OPTION FOR MAINTENANCE\n3                                                                                      PROVISION OF CONSULTANCY SERVICES FOR STRATEGIC BUSINESS PROCESSES RE-ENGINEERING (SBPR) AND ACRA'S IT INFRASTRUCTURE\n4                                                SUPPLY, DELIVERY, DESIGN, CUSTOMISATION, INSTALLATION, CONFIGURATION, TESTING, COMMISSIONING OF A FULLY OPERATIONAL BIZFILE+ WITH AN OPTION FOR MAINTENANCE\n5                                                                                                  PROVISION OF MEDIA MONITORING SERVICES FOR A PERIOD OF TWO YEARS WITH OPTION TO EXTEND FOR UP TO ONE YEAR\n6                 INVITATION TO TENDER FOR THE PROVISION OF CALL CENTRE SERVICES FOR ACCOUNTING AND CORPORATE REGULATORY AUTHORITY FOR A PERIOD OF 3 YEARS WITH OPTION OF UP TO 2 EXTENSIONS OF 2 YEARS EACH\n                                         agency award_date\n1 Accounting And Corporate Regulatory Authority  11/6/2019\n2 Accounting And Corporate Regulatory Authority  10/5/2019\n3 Accounting And Corporate Regulatory Authority  30/4/2019\n4 Accounting And Corporate Regulatory Authority  29/8/2019\n5 Accounting And Corporate Regulatory Authority   6/8/2019\n6 Accounting And Corporate Regulatory Authority  5/11/2019\n     tender_detail_status                            supplier_name awarded_amt\n1    Awarded to Suppliers                          AZAAS PTE. LTD.     2305880\n2 Awarded to No Suppliers                                  Unknown           0\n3    Awarded to Suppliers          ACCENTURE SG SERVICES PTE. LTD.     2035000\n4    Awarded to Suppliers TECH MAHINDRA LIMITED (SINGAPORE BRANCH)    30700374\n5    Awarded to Suppliers                            INSIGHTMATRIX      178800\n6    Awarded to Suppliers                      TDCX (SG) PTE. LTD.     8566831\n  financial_grade agency_abbr            ministry ministry_abbr\n1              S9        ACRA MINISTRY OF FINANCE           MOF\n2            <NA>        ACRA MINISTRY OF FINANCE           MOF\n3             S10        ACRA MINISTRY OF FINANCE           MOF\n4             S10        ACRA MINISTRY OF FINANCE           MOF\n5            <NA>        ACRA MINISTRY OF FINANCE           MOF\n6             S10        ACRA MINISTRY OF FINANCE           MOF\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(procurement_enriched)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 18,638\nColumns: 11\n$ tender_no            <chr> \"ACR000ETT18300010\", \"ACR000ETT18300011\", \"ACR000…\n$ tender_description   <chr> \"SUPPLY, DESIGN, DEVELOPMENT, CUSTOMIZATION, DELI…\n$ agency               <chr> \"Accounting And Corporate Regulatory Authority\", …\n$ award_date           <chr> \"11/6/2019\", \"10/5/2019\", \"30/4/2019\", \"29/8/2019…\n$ tender_detail_status <chr> \"Awarded to Suppliers\", \"Awarded to No Suppliers\"…\n$ supplier_name        <chr> \"AZAAS PTE. LTD.\", \"Unknown\", \"ACCENTURE SG SERVI…\n$ awarded_amt          <dbl> 2305880.0, 0.0, 2035000.0, 30700373.9, 178800.0, …\n$ financial_grade      <chr> \"S9\", NA, \"S10\", \"S10\", NA, \"S10\", \"S10\", \"S10\", …\n$ agency_abbr          <chr> \"ACRA\", \"ACRA\", \"ACRA\", \"ACRA\", \"ACRA\", \"ACRA\", \"…\n$ ministry             <chr> \"MINISTRY OF FINANCE\", \"MINISTRY OF FINANCE\", \"MI…\n$ ministry_abbr        <chr> \"MOF\", \"MOF\", \"MOF\", \"MOF\", \"MOF\", \"MOF\", \"MOF\", …\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert award_date to proper date format\nprocurement_enriched <- procurement_enriched %>%\n  mutate(award_date = as.Date(award_date, format=\"%d/%m/%Y\"))\n\n# Create a year field for filtering\nprocurement_enriched <- procurement_enriched %>%\n  mutate(year = year(award_date))\n\n# Handle missing values in supplier_name\nprocurement_enriched <- procurement_enriched %>%\n  mutate(supplier_name = ifelse(is.na(supplier_name) | supplier_name == \"Unknown\", \"Unspecified Supplier\", supplier_name))\n\n# Create financial grade categories for better visualization\nprocurement_enriched <- procurement_enriched %>%\n  mutate(financial_category = case_when(\n    financial_grade %in% c(\"S1\", \"S2\", \"S3\", \"S4\") ~ \"Small (S1-S4)\",\n    financial_grade %in% c(\"S5\", \"S6\", \"S7\") ~ \"Medium (S5-S7)\",\n    financial_grade %in% c(\"S8\", \"S9\", \"S10\") ~ \"Large (S8-S10)\",\n    TRUE ~ \"Unspecified Grade\"\n  ))\n\n# Preview the processed data\nhead(procurement_enriched)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          tender_no\n1 ACR000ETT18300010\n2 ACR000ETT18300011\n3 ACR000ETT19300001\n4 ACR000ETT19300002\n5 ACR000ETT19300003\n6 ACR000ETT19300004\n                                                                                                                                                                                          tender_description\n1 SUPPLY, DESIGN, DEVELOPMENT, CUSTOMIZATION, DELIVERY, INSTALLATION, TESTING, COMMISSIONING AND MAINTENANCE OF A VARIABLE CAPITAL COMPANIES (VCC) SYSTEM FOR ACCOUNTING AND CORPORATE REGULARTORY AUTHORITY\n2                APPLICATION ENHANCEMENT, CUSTOMISATION, MIGRATION, DELIVERY, INSTALLATION, TESTING AND COMMISSIONING OF THE FULLY OPERATIONAL BIZFINx 2.0 APPLICATION SYSTEM WITH AN OPTION FOR MAINTENANCE\n3                                                                                      PROVISION OF CONSULTANCY SERVICES FOR STRATEGIC BUSINESS PROCESSES RE-ENGINEERING (SBPR) AND ACRA'S IT INFRASTRUCTURE\n4                                                SUPPLY, DELIVERY, DESIGN, CUSTOMISATION, INSTALLATION, CONFIGURATION, TESTING, COMMISSIONING OF A FULLY OPERATIONAL BIZFILE+ WITH AN OPTION FOR MAINTENANCE\n5                                                                                                  PROVISION OF MEDIA MONITORING SERVICES FOR A PERIOD OF TWO YEARS WITH OPTION TO EXTEND FOR UP TO ONE YEAR\n6                 INVITATION TO TENDER FOR THE PROVISION OF CALL CENTRE SERVICES FOR ACCOUNTING AND CORPORATE REGULATORY AUTHORITY FOR A PERIOD OF 3 YEARS WITH OPTION OF UP TO 2 EXTENSIONS OF 2 YEARS EACH\n                                         agency award_date\n1 Accounting And Corporate Regulatory Authority 2019-06-11\n2 Accounting And Corporate Regulatory Authority 2019-05-10\n3 Accounting And Corporate Regulatory Authority 2019-04-30\n4 Accounting And Corporate Regulatory Authority 2019-08-29\n5 Accounting And Corporate Regulatory Authority 2019-08-06\n6 Accounting And Corporate Regulatory Authority 2019-11-05\n     tender_detail_status                            supplier_name awarded_amt\n1    Awarded to Suppliers                          AZAAS PTE. LTD.     2305880\n2 Awarded to No Suppliers                     Unspecified Supplier           0\n3    Awarded to Suppliers          ACCENTURE SG SERVICES PTE. LTD.     2035000\n4    Awarded to Suppliers TECH MAHINDRA LIMITED (SINGAPORE BRANCH)    30700374\n5    Awarded to Suppliers                            INSIGHTMATRIX      178800\n6    Awarded to Suppliers                      TDCX (SG) PTE. LTD.     8566831\n  financial_grade agency_abbr            ministry ministry_abbr year\n1              S9        ACRA MINISTRY OF FINANCE           MOF 2019\n2            <NA>        ACRA MINISTRY OF FINANCE           MOF 2019\n3             S10        ACRA MINISTRY OF FINANCE           MOF 2019\n4             S10        ACRA MINISTRY OF FINANCE           MOF 2019\n5            <NA>        ACRA MINISTRY OF FINANCE           MOF 2019\n6             S10        ACRA MINISTRY OF FINANCE           MOF 2019\n  financial_category\n1     Large (S8-S10)\n2  Unspecified Grade\n3     Large (S8-S10)\n4     Large (S8-S10)\n5  Unspecified Grade\n6     Large (S8-S10)\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Function to prepare data for Sankey diagram\nprepare_sankey_data <- function(data, year_filter = NULL, min_value = 1000000, \n                              group_suppliers = TRUE) {\n  \n  # Apply year filter if specified\n  if (!is.null(year_filter)) {\n    data <- data %>% filter(year == year_filter)\n  }\n  \n  # Create ministry to agency flow\n  ministry_agency_flow <- data %>%\n    group_by(ministry, agency) %>%\n    summarize(value = sum(awarded_amt, na.rm = TRUE), .groups = 'drop') %>%\n    filter(value >= min_value)\n  \n  # Create agency to supplier flow\n  if (group_suppliers) {\n    # Group suppliers by financial category for simplification\n    agency_supplier_flow <- data %>%\n      group_by(agency, financial_category) %>%\n      summarize(value = sum(awarded_amt, na.rm = TRUE), .groups = 'drop') %>%\n      filter(value >= min_value) %>%\n      rename(supplier_name = financial_category)\n  } else {\n    # Use individual suppliers\n    agency_supplier_flow <- data %>%\n      group_by(agency, supplier_name) %>%\n      summarize(value = sum(awarded_amt, na.rm = TRUE), .groups = 'drop') %>%\n      filter(value >= min_value)\n  }\n  \n  # Create nodes dataframe\n  all_nodes <- c(unique(ministry_agency_flow$ministry), \n                unique(ministry_agency_flow$agency),\n                unique(agency_supplier_flow$supplier_name))\n  \n  nodes <- data.frame(\n    name = all_nodes,\n    stringsAsFactors = FALSE\n  )\n  \n  # Create ministry to agency links\n  links_m2a <- ministry_agency_flow %>%\n    mutate(\n      source = match(ministry, nodes$name) - 1,\n      target = match(agency, nodes$name) - 1\n    ) %>%\n    select(source, target, value)\n  \n  # Create agency to supplier links\n  links_a2s <- agency_supplier_flow %>%\n    mutate(\n      source = match(agency, nodes$name) - 1,\n      target = match(supplier_name, nodes$name) - 1\n    ) %>%\n    select(source, target, value)\n  \n  # Combine all links\n  links <- bind_rows(links_m2a, links_a2s)\n  \n  # Return both nodes and links\n  list(nodes = nodes, links = links)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Enhanced Sankey diagram function with better scaling and display options\ncreate_improved_sankey <- function(data, year_filter = NULL, min_value = 100000, \n                                  group_suppliers = TRUE) {\n  \n  # Prepare data\n  sankey_data <- prepare_sankey_data(data, year_filter, min_value, group_suppliers)\n  \n  # Check if we have data\n  if (nrow(sankey_data$nodes) == 0 || nrow(sankey_data$links) == 0) {\n    return(NULL)\n  }\n  \n  # Add group information to nodes for better coloring\n  node_groups <- rep(\"supplier\", nrow(sankey_data$nodes))\n  ministry_names <- unique(data$ministry)\n  agency_names <- unique(data$agency)\n  \n  for (i in 1:length(sankey_data$nodes$name)) {\n    if (sankey_data$nodes$name[i] %in% ministry_names) {\n      node_groups[i] <- \"ministry\"\n    } else if (sankey_data$nodes$name[i] %in% agency_names) {\n      node_groups[i] <- \"agency\"\n    }\n  }\n  \n  sankey_data$nodes$group <- node_groups\n  \n  # Create Sankey diagram with improved settings\n  sankey <- sankeyNetwork(\n    Links = sankey_data$links, \n    Nodes = sankey_data$nodes, \n    Source = \"source\", \n    Target = \"target\", \n    Value = \"value\", \n    NodeID = \"name\",\n    NodeGroup = \"group\",\n    # Use better colors for visibility\n    colourScale = JS('d3.scaleOrdinal().domain([\"ministry\", \"agency\", \"supplier\"]).range([\"#4e79a7\", \"#f28e2c\", \"#59a14f\"])'),\n    # Adjust these to ensure visibility\n    nodeWidth = 20,       # Reduced from 30\n    nodePadding = 15,     # Increased from 10\n    margin = list(top = 20, right = 20, bottom = 20, left = 20),\n    sinksRight = TRUE,\n    fontSize = 10,        # Reduced to fit better\n    height = 800,         # Increased for better visibility\n    width = 1000,\n    iterations = 32       # More iterations for better layout\n  )\n  \n  # Add helpful JavaScript for better display\n  htmlwidgets::onRender(\n    sankey,\n    '\n    function(el, x) {\n      // Ensure the diagram is centered and fits\n      var svg = d3.select(el).select(\"svg\");\n      svg.attr(\"preserveAspectRatio\", \"xMinYMin meet\")\n         .attr(\"viewBox\", \"0 0 1000 800\");\n      \n      // Add zoom functionality\n      var zoom = d3.zoom()\n        .scaleExtent([0.5, 3])\n        .on(\"zoom\", function() {\n          svg.select(\"g\").attr(\"transform\", d3.event.transform);\n        });\n      \n      svg.call(zoom);\n    }\n    '\n  )\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Let's check for extreme value disparities that might cause scaling issues\nvalue_summary <- procurement_enriched %>%\n  filter(year == 2021) %>%\n  group_by(ministry, agency) %>%\n  summarize(total_value = sum(awarded_amt, na.rm = TRUE), .groups = 'drop') %>%\n  summarize(\n    min_value = min(total_value, na.rm = TRUE),\n    max_value = max(total_value, na.rm = TRUE),\n    median_value = median(total_value, na.rm = TRUE),\n    ratio_max_min = max_value / min_value\n  )\n\nprint(value_summary)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 4\n  min_value   max_value median_value ratio_max_min\n      <dbl>       <dbl>        <dbl>         <dbl>\n1         0 9126067311.    23754126.           Inf\n```\n\n\n:::\n\n```{.r .cell-code}\n# If max/min ratio is very high (>1000), let's apply log transformation\nuse_log_transform <- value_summary$ratio_max_min > 1000\n\n# Create improved Sankey\nsankey_improved <- create_improved_sankey(\n  data = procurement_enriched,\n  year_filter = 2021,\n  min_value = 100000000,  # Using a smaller minimum value for more visibility\n  group_suppliers = FALSE\n)\n\n# Display\nsankey_improved\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"htmlwidget-25c9d546829506b7702a\" style=\"width:100%;height:520px;\" class=\"sankeyNetwork html-widget\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-25c9d546829506b7702a\">{\"x\":{\"links\":{\"source\":[0,1,2,3,3,4,5,5,6,6,7,7,8,8,9,10,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,14,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,17,21,21,21,21,22,22,22,22,22],\"target\":[11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,50,69,70,60,68],\"value\":[166317126,155739287.71,101743498.1,207786544.68,160826157.59,346134350.5,524165448.95,166854984.29,5488403367.63,146792518.52,1357199248.95,1565231464.15,189913666.21,375033338.36,9126067311.450001,104090858.9,469976000,119800000,277000000,244800000,513472000,122336800,170820820,263800000,321300000,411380000,153010000,179576000,340000000,257701000,234446989,176700000,445200000,179729512.7,135000000,183372511,156310400.82,180471000,477418000,241094689.2,1050500000,240448000,263000000,979762000,644378000,320000000,262660000,446480000,603535500,780000000,144608000,356103500,748286000,103473685,159996984,322570094,319028892,428077651,125000000,155091000,200720000,116000000,227956999]},\"nodes\":{\"name\":[\"MINISTRY OF CULTURE, COMMUNITY AND YOUTH\",\"MINISTRY OF DIGITAL DEVELOPMENT AND INFORMATION\",\"MINISTRY OF EDUCATION\",\"MINISTRY OF FINANCE\",\"MINISTRY OF HEALTH\",\"MINISTRY OF HOME AFFAIRS\",\"MINISTRY OF NATIONAL DEVELOPMENT\",\"MINISTRY OF SUSTAINABILITY AND THE ENVIRONMENT\",\"MINISTRY OF TRADE AND INDUSTRY\",\"MINISTRY OF TRANSPORT\",\"ORGANS OF STATE\",\"People's Association\",\"Government Technology Agency  (GovTech)\",\"Singapore Polytechnic\",\"Inland Revenue Authority of Singapore\",\"Ministry of Finance - Vital\",\"Ministry of Health-Ministry Headquarter\",\"Ministry of Home Affairs - Ministry Headquarter 1\",\"Ministry of Home Affairs-Ministry Headquarter\",\"Housing and Development Board\",\"National Parks Board\",\"National Environment Agency\",\"Public Utilities Board\",\"Agency for Science, Technology and Research\",\"Jurong Town Corporation\",\"Land Transport Authority\",\"Judiciary-Supreme Court\",\"BHCC CONSTRUCTION PTE. LTD.\",\"CHANG HUA CONSTRUCTION PTE LTD\",\"CHINA CONSTRUCTION (SOUTH PACIFIC) DEVELOPMENT CO. PTE. LTD.\",\"CHIP ENG SENG CONTRACTORS (1988) PTE LTD\",\"CHIU TENG CONSTRUCTION CO. PTE. LTD.\",\"CKR CONTRACT SERVICES PTE. LTD.\",\"EXPAND CONSTRUCTION PTE LTD\",\"GUAN HO CONSTRUCTION CO (PTE) LTD\",\"KAY LIM CONSTRUCTION & TRADING PTE LTD\",\"NEWCON BUILDERS PTE. LTD.\",\"NINGBO CONSTRUCTION GROUP CO., LTD. (SINGAPORE BRANCH)\",\"PRECISE DEVELOPMENT PTE. LTD.\",\"QINGJIAN INTERNATIONAL (SOUTH PACIFIC) GROUP DEVELOPMENT CO., PTE. LTD.\",\"RICH CONSTRUCTION COMPANY PTE. LTD.\",\"TEAMBUILD ENGINEERING & CONSTRUCTION PTE. LTD.\",\"WEE HUR CONSTRUCTION PTE LTD\",\"WELLTECH CONSTRUCTION PTE LTD\",\"ACCENTURE SG SERVICES PTE. LTD.\",\"CHINA STATE CONSTRUCTION ENGINEERING CORPORATION LIMITED SINGAPORE BRANCH\",\"BINTAI KINDENKO PRIVATE LIMITED\",\"CERTIS CISCO AUXILIARY POLICE FORCE PTE. LTD.\",\"CHINA COMMUNICATIONS CONSTRUCTION COMPANY LIMITED (SINGAPORE BRANCH)\",\"CHINA COMMUNICATIONS CONSTRUCTION COMPANY LTD.\",\"CHINA HARBOUR (SINGAPORE) ENGINEERING COMPANY PTE. LTD.\",\"CHINA JINGYE ENGINEERING CORPORATION LIMITED (SINGAPORE BRANCH)\",\"CHYE JOO CONSTRUCTION PTE LTD\",\"China Civil Engineering Construction Corporation Branch Office Singapore - SCB Building Construction Pte. Ltd. Joint Venture\",\"Daewoo Engineering & Construction Co., Ltd. - Dongah Geological Engineering Co., Ltd, Singapore Branch Joint Venture\",\"GAMMON CONSTRUCTION AND ENGINEERING PTE. LTD.\",\"HOCK LIAN SENG INFRASTRUCTURE PTE. LTD.\",\"HWA SENG BUILDER PTE LTD\",\"NISHIMATSU CONSTRUCTION CO LTD\",\"SAMSUNG C&T CORPORATION\",\"SHANGHAI TUNNEL ENGINEERING CO (SINGAPORE) PTE LTD\",\"SHINRYO CORPORATION\",\"Taisei Corporation-China State Construction  Engineering Corporation Limited Singapore Branch Joint Venture\",\"WOH HUP (PRIVATE) LIMITED\",\"TOPPAN NEXT PTE. LTD.\",\"800 SUPER WASTE MANAGEMENT PTE LTD\",\"ALBA GROUP PLC & CO. KG\",\"SEMBWASTE PTE. LTD.\",\"UES HOLDINGS PTE. LTD.\",\"ENG LAM CONTRACTORS CO (PTE) LTD\",\"KOH BROTHERS BUILDING & CIVIL ENGINEERING CONTRACTOR (PTE.) LTD.\"],\"group\":[\"ministry\",\"ministry\",\"ministry\",\"ministry\",\"ministry\",\"ministry\",\"ministry\",\"ministry\",\"ministry\",\"ministry\",\"ministry\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"agency\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\",\"supplier\"]},\"options\":{\"NodeID\":\"name\",\"NodeGroup\":\"group\",\"LinkGroup\":null,\"colourScale\":\"d3.scaleOrdinal().domain([\\\"ministry\\\", \\\"agency\\\", \\\"supplier\\\"]).range([\\\"#4e79a7\\\", \\\"#f28e2c\\\", \\\"#59a14f\\\"])\",\"fontSize\":10,\"fontFamily\":null,\"nodeWidth\":20,\"nodePadding\":15,\"units\":\"\",\"margin\":{\"top\":20,\"right\":20,\"bottom\":20,\"left\":20},\"iterations\":32,\"sinksRight\":true}},\"evals\":[],\"jsHooks\":{\"render\":[{\"code\":\"\\n    function(el, x) {\\n      // Ensure the diagram is centered and fits\\n      var svg = d3.select(el).select(\\\"svg\\\");\\n      svg.attr(\\\"preserveAspectRatio\\\", \\\"xMinYMin meet\\\")\\n         .attr(\\\"viewBox\\\", \\\"0 0 1000 800\\\");\\n      \\n      // Add zoom functionality\\n      var zoom = d3.zoom()\\n        .scaleExtent([0.5, 3])\\n        .on(\\\"zoom\\\", function() {\\n          svg.select(\\\"g\\\").attr(\\\"transform\\\", d3.event.transform);\\n        });\\n      \\n      svg.call(zoom);\\n    }\\n    \",\"data\":null}]}}</script>\n```\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Enhanced Sankey diagram with proper layout and formatting\ncreate_better_sankey <- function(data, year_filter = NULL, min_value = 1000000) {\n  # Filter data\n  if (!is.null(year_filter)) {\n    data <- data %>% filter(year == year_filter)\n  }\n  \n  # Get top N ministries by value to reduce clutter\n  top_ministries <- data %>%\n    group_by(ministry) %>%\n    summarize(total_value = sum(awarded_amt, na.rm = TRUE), .groups = 'drop') %>%\n    arrange(desc(total_value)) %>%\n    head(10) %>%  # Top 10 ministries\n    pull(ministry)\n  \n  # Filter to top ministries\n  filtered_data <- data %>%\n    filter(ministry %in% top_ministries)\n  \n  # Create ministry to agency flow\n  ministry_agency_flow <- filtered_data %>%\n    group_by(ministry, agency) %>%\n    summarize(value = sum(awarded_amt, na.rm = TRUE), .groups = 'drop') %>%\n    filter(value >= min_value) %>%\n    # Get top 30 flows\n    arrange(desc(value)) %>%\n    head(30)\n  \n  # Get agencies from the top flows\n  top_agencies <- unique(ministry_agency_flow$agency)\n  \n  # Create agency to supplier category flow\n  agency_category_flow <- filtered_data %>%\n    filter(agency %in% top_agencies) %>%\n    group_by(agency, financial_category) %>%\n    summarize(value = sum(awarded_amt, na.rm = TRUE), .groups = 'drop') %>%\n    filter(value >= min_value) %>%\n    # Get top 30 flows\n    arrange(desc(value)) %>%\n    head(30)\n  \n  # Create nodes dataframe\n  node_list <- c(top_ministries, top_agencies, unique(agency_category_flow$financial_category))\n  node_list <- unique(node_list) # Remove duplicates\n  \n  nodes <- data.frame(\n    name = node_list,\n    stringsAsFactors = FALSE\n  )\n  \n  # Add group information for coloring\n  nodes$group <- case_when(\n    nodes$name %in% top_ministries ~ \"ministry\",\n    nodes$name %in% top_agencies ~ \"agency\",\n    TRUE ~ \"category\"\n  )\n  \n  # Create links for ministry to agency\n  links_m2a <- ministry_agency_flow %>%\n    filter(ministry %in% nodes$name & agency %in% nodes$name) %>%\n    mutate(\n      source = match(ministry, nodes$name) - 1,\n      target = match(agency, nodes$name) - 1\n    ) %>%\n    select(source, target, value)\n  \n  # Create links for agency to category\n  links_a2c <- agency_category_flow %>%\n    filter(agency %in% nodes$name & financial_category %in% nodes$name) %>%\n    mutate(\n      source = match(agency, nodes$name) - 1,\n      target = match(financial_category, nodes$name) - 1\n    ) %>%\n    select(source, target, value)\n  \n  # Combine links\n  links <- bind_rows(links_m2a, links_a2c)\n  \n  # Add a year title if filtered\n  year_title <- if(!is.null(year_filter)) {\n    paste(\"GeBiz Procurement Flows -\", year_filter)\n  } else {\n    \"GeBiz Procurement Flows - All Years\"\n  }\n  \n  # Create improved Sankey diagram\n  sankey <- sankeyNetwork(\n    Links = links, \n    Nodes = nodes, \n    Source = \"source\", \n    Target = \"target\", \n    Value = \"value\", \n    NodeID = \"name\",\n    NodeGroup = \"group\",\n    # Custom color scheme\n    colourScale = JS('d3.scaleOrdinal()\n                      .domain([\"ministry\", \"agency\", \"category\"])\n                      .range([\"#1f77b4\", \"#ff7f0e\", \"#2ca02c\"])'),\n    # Better layout parameters\n    nodeWidth = 30,\n    nodePadding = 20,\n    margin = list(top = 30, right = 30, bottom = 30, left = 30),\n    sinksRight = TRUE,\n    fontSize = 11,\n    height = 800,\n    width = 1200,\n    iterations = 64  # More iterations for better layout\n  )\n  \n  # Add JavaScript for better rendering and scaling\n  htmlwidgets::onRender(\n    sankey,\n    '\n    function(el, x) {\n      // Ensure diagram is rendered properly\n      d3.select(el).select(\"svg\")\n        .attr(\"viewBox\", \"0 0 1200 800\")\n        .attr(\"preserveAspectRatio\", \"xMidYMid meet\");\n        \n      // Add tooltips with formatted values\n      d3.select(el).selectAll(\".link\")\n        .append(\"title\")\n        .text(function(d) { \n          return d.source.name + \" → \" + d.target.name + \n                 \"\\\\nValue: $\" + d3.format(\",.0f\")(d.value); \n        });\n    }\n    '\n  )\n  \n  return(sankey)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create improved Sankey diagram focusing on top flows\nbetter_sankey <- create_better_sankey(\n  data = procurement_enriched,\n  year_filter = 2021,\n  min_value = 1000000  # 1 million minimum flow value\n)\n\nhtmlwidgets::saveWidget(better_sankey, \"gebiz_sankey.html\", selfcontained = TRUE)\n```\n:::\n\n```{=html}\n<iframe src=\"gebiz_sankey.html\" width=\"100%\" height=\"600px\" frameborder=\"0\"></iframe>\n```\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../site_libs/d3-4.5.0/d3.min.js\"></script>\n<script src=\"../site_libs/sankey-1/sankey.js\"></script>\n<script src=\"../site_libs/sankeyNetwork-binding-0.4/sankeyNetwork.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}